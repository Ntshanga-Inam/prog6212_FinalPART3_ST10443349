@{
    ViewData["Title"] = "HR Reports & Analytics";
}

<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar me-2"></i>Reports & Analytics</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Report Generator</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="payment">Payment Report</option>
                                <option value="monthly">Monthly Summary</option>
                                <option value="lecturer">Lecturer Performance</option>
                                <option value="department">Department Analysis</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="startDate" value="@DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd")">
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" id="endDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="exportFormat">
                                <option value="html">HTML Report</option>
                                <option value="csv">CSV Export</option>
                                <option value="pdf">PDF (Simulated)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-cog me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Reports</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary text-start" onclick="generateThisMonthReport()">
                        <i class="fas fa-calendar me-2"></i>This Month's Summary
                    </button>
                    <button class="btn btn-outline-success text-start" onclick="generateYTDReport()">
                        <i class="fas fa-chart-line me-2"></i>Year-to-Date Analysis
                    </button>
                    <button class="btn btn-outline-info text-start" onclick="generateLecturerReport()">
                        <i class="fas fa-users me-2"></i>Top Lecturers Report
                    </button>
                    <button class="btn btn-outline-warning text-start" onclick="generatePendingReport()">
                        <i class="fas fa-clock me-2"></i>Pending Claims Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Report Output</h5>
                <div id="reportActions" style="display: none;">
                    <button class="btn btn-sm btn-success" onclick="exportReport()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="printReport()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="reportOutput" class="report-container">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>Select report parameters and click "Generate Report" to view analytics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .report-container {
            min-height: 400px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .stat-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .report-table {
            font-size: 0.9em;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentReportData = null;

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const format = document.getElementById('exportFormat').value;

            const request = {
                reportType: reportType,
                startDate: startDate,
                endDate: endDate,
                format: format
            };

            showLoading();

            // Simulate API call based on report type
            switch (reportType) {
                case 'payment':
                    generatePaymentReport(request);
                    break;
                case 'monthly':
                    generateMonthlyReport(request);
                    break;
                case 'lecturer':
                    generateLecturerReport(request);
                    break;
                default:
                    generatePaymentReport(request);
            }
        }

        function generatePaymentReport(request) {
            fetch('@Url.Action("GeneratePaymentReport", "HR")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentReportData = data.data;
                    displayPaymentReport(data.data);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Unable to generate report');
            });
        }

        function generateMonthlyReport(request) {
            const currentDate = new Date();
            const monthlyRequest = {
                year: currentDate.getFullYear(),
                month: currentDate.getMonth() + 1
            };

            fetch('@Url.Action("GenerateMonthlySummary", "HR")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(monthlyRequest)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentReportData = data.data;
                    displayMonthlyReport(data.data);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Unable to generate monthly report');
            });
        }

        function displayPaymentReport(data) {
            const output = document.getElementById('reportOutput');
            output.innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h4>Payment Report</h4>
                        <p class="text-muted">Period: ${new Date(data.periodStart).toLocaleDateString()} to ${new Date(data.periodEnd).toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h5>Total Claims</h5>
                            <h3 class="text-primary">${data.totalClaims}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h5>Total Amount</h5>
                            <h3 class="text-success">R ${data.totalAmount.toFixed(2)}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h5>Average per Claim</h5>
                            <h3 class="text-info">R ${(data.totalAmount / data.totalClaims).toFixed(2)}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h5>Report Date</h5>
                            <h3 class="text-warning">${new Date(data.generatedDate).toLocaleDateString()}</h3>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6>Claims Overview</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped report-table">
                                        <thead>
                                            <tr>
                                                <th>Claim ID</th>
                                                <th>Lecturer</th>
                                                <th>Amount</th>
                                                <th>Approved Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.claims.map(claim => `
                                                <tr>
                                                    <td>#${claim.claimId}</td>
                                                    <td>${getLecturerName(claim.lecturerId)}</td>
                                                    <td>R ${claim.amount.toFixed(2)}</td>
                                                    <td>${new Date(claim.approvedDate).toLocaleDateString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6>Amount Distribution</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="amountChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize chart
            initializeAmountChart(data.claims);
            document.getElementById('reportActions').style.display = 'block';
        }

        function displayMonthlyReport(data) {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];

            const output = document.getElementById('reportOutput');
            output.innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h4>Monthly Summary - ${monthNames[data.month - 1]} ${data.year}</h4>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h6>Total Claims</h6>
                            <h4 class="text-primary">${data.totalClaims}</h4>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h6>Approved</h6>
                            <h4 class="text-success">${data.approvedClaims}</h4>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <h6>Pending</h6>
                            <h4 class="text-warning">${data.pendingClaims}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h6>Total Amount</h6>
                            <h4 class="text-info">R ${data.totalAmount.toFixed(2)}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <h6>Approval Rate</h6>
                            <h4 class="text-success">${((data.approvedClaims / data.totalClaims) * 100).toFixed(1)}%</h4>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>Claims by Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>Top Lecturers</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Lecturer</th>
                                                <th>Claims</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.topLecturers.map(lecturer => `
                                                <tr>
                                                    <td>${getLecturerName(lecturer.lecturerId)}</td>
                                                    <td>${lecturer.claimCount}</td>
                                                    <td>R ${lecturer.totalAmount.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            initializeStatusChart(data.claimsByStatus);
            document.getElementById('reportActions').style.display = 'block';
        }

        function initializeAmountChart(claims) {
            const ctx = document.getElementById('amountChart').getContext('2d');
            const amounts = claims.map(c => c.amount);
            const labels = claims.map(c => `#${c.claimId}`);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Claim Amount (R)',
                        data: amounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeStatusChart(claimsByStatus) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const labels = Object.keys(claimsByStatus);
            const data = Object.values(claimsByStatus);

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',  // Green for Approved
                            'rgba(255, 193, 7, 0.8)',   // Yellow for Pending
                            'rgba(23, 162, 184, 0.8)',  // Blue for With Manager
                            'rgba(108, 117, 125, 0.8)'  // Gray for others
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function getLecturerName(lecturerId) {
            const lecturers = {
                'lecturer1': 'Dr. John Smith',
                'lecturer2': 'Dr. Sarah Johnson'
            };
            return lecturers[lecturerId] || 'Unknown Lecturer';
        }

        function showLoading() {
            document.getElementById('reportOutput').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Generating report...</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('reportOutput').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }

        function exportReport() {
            alert('Export functionality would be implemented here with libraries like SheetJS or similar.');
        }

        function printReport() {
            window.print();
        }

        // Quick report functions
        function generateThisMonthReport() {
            const currentDate = new Date();
            document.getElementById('reportType').value = 'monthly';
            document.getElementById('startDate').value = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('endDate').value = currentDate.toISOString().split('T')[0];
            generateReport();
        }

        function generateYTDReport() {
            const currentDate = new Date();
            document.getElementById('reportType').value = 'payment';
            document.getElementById('startDate').value = new Date(currentDate.getFullYear(), 0, 1).toISOString().split('T')[0];
            document.getElementById('endDate').value = currentDate.toISOString().split('T')[0];
            generateReport();
        }

        function generateLecturerReport() {
            document.getElementById('reportType').value = 'lecturer';
            generateReport();
        }

        function generatePendingReport() {
            alert('Pending claims report would show all claims awaiting approval.');
        }
    </script>
}